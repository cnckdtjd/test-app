<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout :: head('주문하기')"></head>
<body>
    <header th:replace="fragments/layout :: header"></header>
    
    <div class="container">
        <h1 class="my-4">주문하기</h1>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>주문 상품 정보</h3>
                    </div>
                    <div class="card-body">
                        <div id="orderItems">
                            <!-- 주문 상품 목록이 여기에 동적으로 로드됩니다 -->
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>배송 정보</h3>
                    </div>
                    <div class="card-body">
                        <form id="shippingForm">
                            <div class="form-group">
                                <label for="receiverName" class="form-label">받는 사람</label>
                                <input type="text" id="receiverName" name="receiverName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="receiverPhone" class="form-label">연락처</label>
                                <input type="text" id="receiverPhone" name="receiverPhone" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="zipcode" class="form-label">우편번호</label>
                                <div class="input-group">
                                    <input type="text" id="zipcode" name="zipcode" class="form-control" readonly required>
                                    <div class="input-group-append">
                                        <button type="button" class="btn" onclick="searchAddress()">주소 검색</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="address1" class="form-label">기본주소</label>
                                <input type="text" id="address1" name="address1" class="form-control" readonly required>
                            </div>
                            <div class="form-group">
                                <label for="address2" class="form-label">상세주소</label>
                                <input type="text" id="address2" name="address2" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="deliveryRequest" class="form-label">배송 요청사항</label>
                                <select id="deliveryRequest" name="deliveryRequest" class="form-control">
                                    <option value="">배송 시 요청사항을 선택해주세요</option>
                                    <option value="문 앞에 놓아주세요">문 앞에 놓아주세요</option>
                                    <option value="경비실에 맡겨주세요">경비실에 맡겨주세요</option>
                                    <option value="배송 전 연락해주세요">배송 전 연락해주세요</option>
                                    <option value="custom">직접 입력</option>
                                </select>
                            </div>
                            <div id="customRequestContainer" class="form-group" style="display: none;">
                                <label for="customRequest" class="form-label">직접 입력</label>
                                <input type="text" id="customRequest" name="customRequest" class="form-control">
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3>결제 방법</h3>
                    </div>
                    <div class="card-body">
                        <div class="payment-methods">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card" checked>
                                <label class="form-check-label" for="card">신용카드</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="transfer" value="transfer">
                                <label class="form-check-label" for="transfer">계좌이체</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="virtual" value="virtual">
                                <label class="form-check-label" for="virtual">가상계좌</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="phone" value="phone">
                                <label class="form-check-label" for="phone">휴대폰 결제</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3>결제 요약</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <p>상품 금액:</p>
                                <p>배송비:</p>
                                <p>할인 금액:</p>
                                <p><strong>결제 금액:</strong></p>
                            </div>
                            <div class="col-6 text-right">
                                <p id="subtotal">0원</p>
                                <p id="shipping">0원</p>
                                <p id="discount">0원</p>
                                <p><strong id="total">0원</strong></p>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3 mt-4">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                결제 진행 및 결제 대행 서비스 이용약관에 동의합니다.
                            </label>
                        </div>
                        
                        <button id="placeOrderBtn" class="btn btn-lg btn-block mt-3">결제하기</button>
                        <button id="backToCartBtn" class="btn btn-secondary btn-lg btn-block mt-2">장바구니로 돌아가기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer th:replace="fragments/layout :: footer"></footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadOrderItems();
            loadUserInfo();
            
            document.getElementById('deliveryRequest').addEventListener('change', function() {
                const customRequestContainer = document.getElementById('customRequestContainer');
                customRequestContainer.style.display = this.value === 'custom' ? 'block' : 'none';
            });
            
            document.getElementById('placeOrderBtn').addEventListener('click', function() {
                if (!document.getElementById('agreeTerms').checked) {
                    showAlert('이용약관에 동의해주세요.', 'danger');
                    return;
                }
                
                if (!validateForm('shippingForm')) {
                    showAlert('배송 정보를 모두 입력해주세요.', 'danger');
                    return;
                }
                
                placeOrder();
            });
            
            document.getElementById('backToCartBtn').addEventListener('click', function() {
                window.location.href = '/cart-service/cart';
            });
        });
        
        async function loadOrderItems() {
            try {
                const token = getToken();
                if (!token) {
                    window.location.href = '/user-service/login';
                    return;
                }
                
                let orderItems = [];
                const isDirectOrder = window.location.pathname.includes('/direct');
                
                if (isDirectOrder) {
                    // 바로 구매 - localStorage에서 상품 정보 가져오기
                    const directOrderItems = JSON.parse(localStorage.getItem('direct_order_items') || '[]');
                    
                    if (directOrderItems.length === 0) {
                        window.location.href = '/product-service/products';
                        return;
                    }
                    
                    // 상품 정보 가져오기
                    for (const item of directOrderItems) {
                        const productResponse = await fetch(`/product-service/api/products/${item.productId}`);
                        
                        if (!productResponse.ok) {
                            throw new Error('상품 정보를 불러오는데 실패했습니다.');
                        }
                        
                        const product = await productResponse.json();
                        
                        orderItems.push({
                            productId: product.id,
                            productName: product.name,
                            price: product.price,
                            quantity: item.quantity,
                            imageUrl: product.imageUrl
                        });
                    }
                } else {
                    // 장바구니에서 주문 - 장바구니 API 호출
                    const cartResponse = await fetch('/cart-service/api/carts/current', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!cartResponse.ok) {
                        throw new Error('장바구니를 불러오는데 실패했습니다.');
                    }
                    
                    const cartData = await cartResponse.json();
                    
                    if (!cartData.items || cartData.items.length === 0) {
                        window.location.href = '/cart-service/cart';
                        return;
                    }
                    
                    orderItems = cartData.items;
                }
                
                // 주문 상품 목록 표시
                const orderItemsContainer = document.getElementById('orderItems');
                
                let html = `
                    <div class="table-responsive">
                        <table class="table order-table">
                            <thead>
                                <tr>
                                    <th>상품 정보</th>
                                    <th>가격</th>
                                    <th>수량</th>
                                    <th>합계</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let subtotal = 0;
                
                orderItems.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    
                    html += `
                        <tr>
                            <td>
                                <div class="order-item-info">
                                    <img src="${item.imageUrl || '/product-service/images/no-image.jpg'}" alt="${item.productName}" class="order-item-image">
                                    <div>
                                        <p class="order-item-name">${item.productName}</p>
                                    </div>
                                </div>
                            </td>
                            <td>${item.price.toLocaleString()}원</td>
                            <td>${item.quantity}</td>
                            <td>${itemTotal.toLocaleString()}원</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                orderItemsContainer.innerHTML = html;
                
                // 주문 요약 정보 업데이트
                const shipping = subtotal > 0 ? 3000 : 0; // 예시: 3,000원 배송비
                const discount = 0; // 할인 금액
                const total = subtotal + shipping - discount;
                
                document.getElementById('subtotal').textContent = `${subtotal.toLocaleString()}원`;
                document.getElementById('shipping').textContent = `${shipping.toLocaleString()}원`;
                document.getElementById('discount').textContent = `${discount.toLocaleString()}원`;
                document.getElementById('total').textContent = `${total.toLocaleString()}원`;
                
                // 주문 정보를 세션에 저장
                sessionStorage.setItem('order_items', JSON.stringify(orderItems));
                sessionStorage.setItem('order_subtotal', subtotal);
                sessionStorage.setItem('order_shipping', shipping);
                sessionStorage.setItem('order_discount', discount);
                sessionStorage.setItem('order_total', total);
                
            } catch (error) {
                console.error('Error:', error);
                showAlert(error.message, 'danger');
            }
        }
        
        async function loadUserInfo() {
            try {
                const token = getToken();
                if (!token) {
                    window.location.href = '/user-service/login';
                    return;
                }
                
                const response = await fetch('/user-service/api/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('사용자 정보를 불러오는데 실패했습니다.');
                }
                
                const user = await response.json();
                
                // 배송지 정보 기본값 설정 (있을 경우)
                if (user.name) {
                    document.getElementById('receiverName').value = user.name;
                }
                
                if (user.phone) {
                    document.getElementById('receiverPhone').value = user.phone;
                }
                
                if (user.address) {
                    // 주소가 저장되어 있다면 설정
                    document.getElementById('zipcode').value = user.address.zipcode || '';
                    document.getElementById('address1').value = user.address.address1 || '';
                    document.getElementById('address2').value = user.address.address2 || '';
                }
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function searchAddress() {
            // 실제 구현 시에는 다음(카카오) 우편번호 서비스 등을 연동
            // 예시로만 간단히 구현
            alert('주소 검색 기능은 실제 구현 시 다음(카카오) 우편번호 서비스 등을 연동해야 합니다.');
            
            // 테스트용 예시 주소
            document.getElementById('zipcode').value = '12345';
            document.getElementById('address1').value = '서울시 강남구 테헤란로 123';
        }
        
        async function placeOrder() {
            try {
                const token = getToken();
                if (!token) {
                    window.location.href = '/user-service/login';
                    return;
                }
                
                const orderItems = JSON.parse(sessionStorage.getItem('order_items') || '[]');
                const total = parseInt(sessionStorage.getItem('order_total') || '0', 10);
                
                if (orderItems.length === 0 || total <= 0) {
                    throw new Error('주문 정보가 올바르지 않습니다.');
                }
                
                const deliveryRequest = document.getElementById('deliveryRequest').value;
                const customRequest = document.getElementById('customRequest').value;
                
                const orderData = {
                    orderItems: orderItems.map(item => ({
                        productId: item.productId,
                        quantity: item.quantity,
                        price: item.price
                    })),
                    shippingInfo: {
                        receiverName: document.getElementById('receiverName').value,
                        receiverPhone: document.getElementById('receiverPhone').value,
                        zipcode: document.getElementById('zipcode').value,
                        address1: document.getElementById('address1').value,
                        address2: document.getElementById('address2').value,
                        deliveryRequest: deliveryRequest === 'custom' ? customRequest : deliveryRequest
                    },
                    paymentInfo: {
                        method: document.querySelector('input[name="paymentMethod"]:checked').value,
                        amount: total
                    }
                };
                
                const response = await fetch('/order-service/api/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });
                
                if (!response.ok) {
                    throw new Error('주문 처리에 실패했습니다.');
                }
                
                const result = await response.json();
                
                // 주문 완료 페이지로 이동
                window.location.href = `/order-service/orders/${result.orderId}/complete`;
                
            } catch (error) {
                console.error('Error:', error);
                showAlert(error.message, 'danger');
            }
        }
    </script>

    <style>
        .order-table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 30px;
        }
        
        .order-table th {
            background-color: var(--light-gray);
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .order-table td {
            padding: 15px 12px;
            vertical-align: middle;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .order-item-info {
            display: flex;
            align-items: center;
        }
        
        .order-item-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 4px;
        }
        
        .order-item-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .payment-methods {
            margin-top: 10px;
        }
        
        .form-check-input {
            margin-top: 0.3rem;
        }
        
        .form-check-label {
            margin-left: 0.5rem;
        }
    </style>
</body>
</html> 