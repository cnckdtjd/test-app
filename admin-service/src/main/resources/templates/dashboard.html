<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout :: head('관리자 대시보드')"></head>
<body>
    <header th:replace="fragments/layout :: header"></header>
    
    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin-service/dashboard">
                                <i class="fas fa-tachometer-alt"></i> 대시보드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin-service/users">
                                <i class="fas fa-users"></i> 회원 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin-service/products">
                                <i class="fas fa-box"></i> 상품 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin-service/orders">
                                <i class="fas fa-shopping-cart"></i> 주문 관리
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin-service/statistics">
                                <i class="fas fa-chart-bar"></i> 통계
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin-service/test-data">
                                <i class="fas fa-database"></i> 테스트 데이터
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <main role="main" class="col-md-10 ml-sm-auto px-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">대시보드</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group mr-2">
                            <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i> 새로고침
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">총 회원수</h5>
                                <p class="card-text count" id="totalUsers">0</p>
                                <small class="text-muted">활성 회원: <span id="activeUsers">0</span>명</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">총 상품수</h5>
                                <p class="card-text count" id="totalProducts">0</p>
                                <small class="text-muted">재고 부족: <span id="lowStockProducts">0</span>개</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">총 주문수</h5>
                                <p class="card-text count" id="totalOrders">0</p>
                                <small class="text-muted">오늘: <span id="newOrdersToday">0</span>건</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card dashboard-card">
                            <div class="card-body">
                                <h5 class="card-title">총 매출</h5>
                                <p class="card-text count" id="totalRevenue">0원</p>
                                <small class="text-muted">이번 달: <span id="thisMonthRevenue">0</span>원</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h5 class="card-title">일별 매출 추이</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h5 class="card-title">카테고리별 판매 비율</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title">최근 주문</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>주문번호</th>
                                                <th>고객명</th>
                                                <th>주문일시</th>
                                                <th>상품</th>
                                                <th>금액</th>
                                                <th>상태</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentOrdersTable">
                                            <!-- 최근 주문 목록이 여기에 동적으로 로드됩니다 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadDashboardData();
            });
        });
        
        async function loadDashboardData() {
            try {
                const response = await fetch('/admin-service/api/admin/dashboard');
                
                if (!response.ok) {
                    throw new Error('대시보드 데이터를 불러오는데 실패했습니다.');
                }
                
                const data = await response.json();
                
                // 카드 정보 업데이트
                document.getElementById('totalUsers').textContent = data.totalUsers.toLocaleString();
                document.getElementById('activeUsers').textContent = data.activeUsers.toLocaleString();
                document.getElementById('totalProducts').textContent = data.totalProducts.toLocaleString();
                document.getElementById('lowStockProducts').textContent = data.lowStockProducts.toLocaleString();
                document.getElementById('totalOrders').textContent = data.totalOrders.toLocaleString();
                document.getElementById('newOrdersToday').textContent = data.newOrdersToday.toLocaleString();
                document.getElementById('totalRevenue').textContent = data.totalRevenue.toLocaleString() + '원';
                document.getElementById('thisMonthRevenue').textContent = (data.thisMonthRevenue || 0).toLocaleString() + '원';
                
                // 차트 데이터 로드
                loadCharts();
                
                // 최근 주문 목록 로드
                loadRecentOrders();
                
            } catch (error) {
                console.error('Error:', error);
                alert('대시보드 데이터를 불러오는데 실패했습니다.');
            }
        }
        
        async function loadCharts() {
            try {
                // 매출 차트 데이터 가져오기
                const revenueResponse = await fetch('/admin-service/api/admin/statistics/daily-revenue');
                
                if (!revenueResponse.ok) {
                    throw new Error('매출 데이터를 불러오는데 실패했습니다.');
                }
                
                const revenueData = await revenueResponse.json();
                
                // 카테고리 차트 데이터 가져오기
                const categoryResponse = await fetch('/admin-service/api/admin/statistics/category-sales');
                
                if (!categoryResponse.ok) {
                    throw new Error('카테고리 데이터를 불러오는데 실패했습니다.');
                }
                
                const categoryData = await categoryResponse.json();
                
                // 매출 차트 생성
                createRevenueChart(revenueData);
                
                // 카테고리 차트 생성
                createCategoryChart(categoryData);
                
            } catch (error) {
                console.error('Error:', error);
                alert('차트 데이터를 불러오는데 실패했습니다.');
            }
        }
        
        function createRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // 기존 차트 제거
            if (window.revenueChart) {
                window.revenueChart.destroy();
            }
            
            // 차트 생성
            window.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.date),
                    datasets: [{
                        label: '일별 매출',
                        data: data.map(item => item.revenue),
                        backgroundColor: 'rgba(66, 133, 244, 0.2)',
                        borderColor: 'rgba(66, 133, 244, 1)',
                        borderWidth: 1,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function createCategoryChart(data) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // 기존 차트 제거
            if (window.categoryChart) {
                window.categoryChart.destroy();
            }
            
            // 차트 생성
            window.categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(item => item.category),
                    datasets: [{
                        data: data.map(item => item.sales),
                        backgroundColor: [
                            'rgba(66, 133, 244, 0.8)',
                            'rgba(52, 168, 83, 0.8)',
                            'rgba(251, 188, 5, 0.8)',
                            'rgba(234, 67, 53, 0.8)',
                            'rgba(103, 58, 183, 0.8)',
                            'rgba(0, 188, 212, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        async function loadRecentOrders() {
            try {
                const response = await fetch('/admin-service/api/admin/orders/recent');
                
                if (!response.ok) {
                    throw new Error('최근 주문 목록을 불러오는데 실패했습니다.');
                }
                
                const orders = await response.json();
                
                const recentOrdersTable = document.getElementById('recentOrdersTable');
                recentOrdersTable.innerHTML = '';
                
                if (orders.length === 0) {
                    recentOrdersTable.innerHTML = '<tr><td colspan="7" class="text-center">최근 주문이 없습니다.</td></tr>';
                    return;
                }
                
                orders.forEach(order => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${order.orderNumber}</td>
                        <td>${order.customerName}</td>
                        <td>${new Date(order.orderedAt).toLocaleString()}</td>
                        <td>${order.itemCount}개 상품</td>
                        <td>${order.totalAmount.toLocaleString()}원</td>
                        <td><span class="status-badge ${order.status.toLowerCase()}">${getStatusText(order.status)}</span></td>
                        <td><a href="/admin-service/orders/${order.id}" class="btn btn-sm">상세보기</a></td>
                    `;
                    
                    recentOrdersTable.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('recentOrdersTable').innerHTML = 
                    '<tr><td colspan="7" class="text-center">주문 정보를 불러오는데 실패했습니다.</td></tr>';
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'ORDERED': '주문완료',
                'PAID': '결제완료',
                'PREPARING': '상품준비중',
                'SHIPPING': '배송중',
                'DELIVERED': '배송완료',
                'CANCELED': '취소'
            };
            
            return statusMap[status] || status;
        }
    </script>
    
    <style>
        /* 사이드바 스타일 */
        .sidebar {
            position: fixed;
            top: 72px;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 20px 0;
            background-color: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }
        
        .sidebar-sticky {
            position: sticky;
            top: 0;
            height: calc(100vh - 72px);
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            font-weight: 500;
            color: var(--text-color);
            padding: 0.75rem 1rem;
        }
        
        .sidebar .nav-link:hover {
            background-color: var(--medium-gray);
        }
        
        .sidebar .nav-link.active {
            color: var(--primary-color);
            background-color: rgba(66, 133, 244, 0.1);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        
        /* 메인 컨텐츠 스타일 */
        main {
            margin-top: 72px;
            padding-bottom: 50px;
        }
        
        /* 대시보드 카드 스타일 */
        .dashboard-card {
            height: 160px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .dashboard-card .card-title {
            font-size: 16px;
            color: var(--dark-gray);
            margin-bottom: 20px;
        }
        
        .dashboard-card .count {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        /* 차트 카드 스타일 */
        .chart-card {
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        /* 테이블 스타일 */
        .table th {
            font-weight: 600;
            background-color: var(--light-gray);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.ordered {
            background-color: var(--light-gray);
            color: var(--text-color);
        }
        
        .status-badge.paid {
            background-color: rgba(66, 133, 244, 0.1);
            color: var(--primary-color);
        }
        
        .status-badge.preparing {
            background-color: rgba(251, 188, 5, 0.1);
            color: var(--warning-color);
        }
        
        .status-badge.shipping {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
        }
        
        .status-badge.delivered {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--secondary-color);
        }
        
        .status-badge.canceled {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--danger-color);
        }
    </style>
</body>
</html> 