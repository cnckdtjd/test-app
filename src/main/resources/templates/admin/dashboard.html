<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
</head>
<body>
    <section layout:fragment="content">
        <h2 class="mb-4">관리자 대시보드</h2>
        
        <!-- 요약 카드 -->
        <div class="row">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    사용자 수</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${userCount}">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-people fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    상품 수</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${productCount}">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-box-seam fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    주문 수</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${orderCount}">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-cart-check fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    총 매출</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${totalSales != null ? #numbers.formatCurrency(totalSales) : '0원'}">0원</div>
                            </div>
                            <div class="col-auto">
                                <i class="bi bi-currency-dollar fs-2 text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 테스트 데이터 관리 -->
        <div class="row">
            <!-- 데이터 생성 -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">테스트 데이터 생성</h6>
                    </div>
                    <div class="card-body">
                        <p>부하 테스트를 위한 대량의 데이터를 자동으로 생성합니다.</p>
                        <form id="generateDataForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="userCount" class="form-label">사용자 수</label>
                                    <input type="number" class="form-control" id="userCount" value="100" min="1" max="10000">
                                </div>
                                <div class="col-md-6">
                                    <label for="productCount" class="form-label">상품 수</label>
                                    <input type="number" class="form-control" id="productCount" value="1000" min="1" max="10000">
                                </div>
                            </div>
                            <button type="button" id="generateDataBtn" class="btn btn-primary">
                                <i class="bi bi-database-add"></i> 데이터 생성
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 데이터 롤백 -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">테스트 데이터 롤백</h6>
                    </div>
                    <div class="card-body">
                        <p>생성된 테스트 데이터를 롤백합니다. 관리자 계정과 기본 사용자 계정은 유지됩니다.</p>
                        <button type="button" id="rollbackDataBtn" class="btn btn-danger">
                            <i class="bi bi-database-x"></i> 데이터 롤백
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 시스템 자원 모니터링 -->
        <div class="row">
            <h4 class="mb-3 mt-2">시스템 자원 모니터링</h4>
            <!-- CPU 사용률 카드 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">CPU 사용률</h6>
                    </div>
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="chart-container">
                                    <canvas id="cpuUsageChart"></canvas>
                                </div>
                            </div>
                            <div class="col-auto">
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="cpuUsageValue">
                                    <span th:text="${systemResources != null ? systemResources.cpuUsage : '0.00'}">0.00</span>%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메모리 사용량 카드 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">메모리 사용량</h6>
                    </div>
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="small font-weight-bold">
                                    총 메모리: <span th:text="${systemResources != null ? systemResources.totalMemory : '0 MB'}">0 MB</span>
                                </div>
                                <div class="small font-weight-bold">
                                    사용 중: <span th:text="${systemResources != null ? systemResources.usedMemory : '0 MB'}">0 MB</span>
                                </div>
                                <div class="small font-weight-bold">
                                    여유 메모리: <span th:text="${systemResources != null ? systemResources.freeMemory : '0 MB'}">0 MB</span>
                                </div>
                                <div class="progress mb-4 mt-2">
                                    <div class="progress-bar bg-primary" role="progressbar" 
                                        th:style="'width: ' + ${systemResources != null ? systemResources.memoryUsagePercent : '0'} + '%'" 
                                        aria-valuemin="0" aria-valuemax="100">
                                        <span th:text="${systemResources != null ? systemResources.memoryUsagePercent : '0.00'}">0.00</span>%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 힙 메모리 사용량 카드 -->
            <div class="col-xl-4 col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">JVM 힙 메모리</h6>
                    </div>
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="small font-weight-bold">
                                    최대 힙 크기: <span th:text="${systemResources != null ? systemResources.heapMemoryMax : '0 MB'}">0 MB</span>
                                </div>
                                <div class="small font-weight-bold">
                                    사용 중인 힙: <span th:text="${systemResources != null ? systemResources.heapMemoryUsed : '0 MB'}">0 MB</span>
                                </div>
                                <div class="progress mb-4 mt-2">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                        th:style="'width: ' + ${systemResources != null ? systemResources.heapUsagePercent : '0'} + '%'" 
                                        aria-valuemin="0" aria-valuemax="100">
                                        <span th:text="${systemResources != null ? systemResources.heapUsagePercent : '0.00'}">0.00</span>%
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 페이지별 스크립트 -->
    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            // 차트 데이터
            const cpuUsage = /*[[${systemResources != null ? systemResources.cpuUsageRaw : 0}]]*/ 0;
            const memoryUsage = /*[[${systemResources != null ? systemResources.memoryUsageRaw : 0}]]*/ 0;
            const heapUsage = /*[[${systemResources != null ? systemResources.heapUsageRaw : 0}]]*/ 0;
            
            // CPU 사용량 차트
            const cpuCtx = document.getElementById('cpuUsageChart').getContext('2d');
            const cpuChart = new Chart(cpuCtx, {
                type: 'doughnut',
                data: {
                    labels: ['사용 중', '여유'],
                    datasets: [{
                        data: [cpuUsage, 100 - cpuUsage],
                        backgroundColor: ['#4e73df', '#f8f9fc'],
                        hoverBackgroundColor: ['#2e59d9', '#eaecf4'],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // 메모리 사용량 차트
            const memCtx = document.getElementById('memoryUsageChart').getContext('2d');
            const memChart = new Chart(memCtx, {
                type: 'doughnut',
                data: {
                    labels: ['사용 중', '여유'],
                    datasets: [{
                        data: [memoryUsage, 100 - memoryUsage],
                        backgroundColor: ['#1cc88a', '#f8f9fc'],
                        hoverBackgroundColor: ['#17a673', '#eaecf4'],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // 힙 메모리 사용량 차트
            const heapCtx = document.getElementById('heapUsageChart').getContext('2d');
            const heapChart = new Chart(heapCtx, {
                type: 'doughnut',
                data: {
                    labels: ['사용 중', '여유'],
                    datasets: [{
                        data: [heapUsage, 100 - heapUsage],
                        backgroundColor: ['#f6c23e', '#f8f9fc'],
                        hoverBackgroundColor: ['#dda20a', '#eaecf4'],
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }],
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            
            // 테스트 데이터 생성
            document.getElementById('generateDataBtn').addEventListener('click', function() {
                const userCount = document.getElementById('userCount').value;
                const productCount = document.getElementById('productCount').value;
                
                // 로딩 상태로 변경
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 처리 중...';
                
                fetch(`/admin/test-data/generate?userCount=${userCount}&productCount=${productCount}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('테스트 데이터가 성공적으로 생성되었습니다.');
                        window.location.reload();
                    } else {
                        alert('데이터 생성 실패: ' + data.message);
                        // 버튼 초기화
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-database-add"></i> 데이터 생성';
                    }
                })
                .catch(error => {
                    alert('오류가 발생했습니다: ' + error);
                    // 버튼 초기화
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-database-add"></i> 데이터 생성';
                });
            });
            
            // 테스트 데이터 롤백
            document.getElementById('rollbackDataBtn').addEventListener('click', function() {
                if (confirm('정말로 테스트 데이터를 롤백하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                    // 로딩 상태로 변경
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 처리 중...';
                    
                    fetch('/admin/test-data/rollback', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('데이터가 성공적으로 롤백되었습니다.');
                            window.location.reload();
                        } else {
                            alert('데이터 롤백 실패: ' + data.message);
                            // 버튼 초기화
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-database-x"></i> 데이터 롤백';
                        }
                    })
                    .catch(error => {
                        alert('오류가 발생했습니다: ' + error);
                        // 버튼 초기화
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-database-x"></i> 데이터 롤백';
                    });
                }
            });
        </script>
    </th:block>
</body>
</html> 